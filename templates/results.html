<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agent Analysis Status</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    
    <main class="container">
      <header>
        <h1>Analysis Status</h1>
        <p class="lede">Run ID: <code>{{ run_id }}</code></p>
      </header>
      <section class="panel">
        <h3>Progress Log</h3>
        <div id="log" class="log"></div>
      </section>
      <section class="panel downloads" id="downloads" style="display:none;">
        <h3>Generated Files</h3>
        <ul id="file-list"></ul>
        <div class="help">Written under: <code>{{ output_dir }}</code></div>
      </section>
      <div style="margin-top:10px;"><a href="{{ url_for('index') }}">&#8592; Back</a></div>
    </main>
    <script>
      const runId = {{ run_id|tojson }};
      const logEl = document.getElementById('log');
      const dlEl = document.getElementById('downloads');
      const listEl = document.getElementById('file-list');
      let done = false;
      // Apply skeleton while loading
      logEl.classList.add('skeleton');
      async function poll() {
        try {
          const res = await fetch({{ url_for('progress', run_id='__RUN__')|tojson }}.replace('__RUN__', runId));
          const data = await res.json();
          const lines = data.lines || [];
          if (lines.length) {
            logEl.classList.remove('skeleton');
          }
          logEl.textContent = lines.join('\n');
          if (data.complete && !done) {
            done = true;
            dlEl.style.display = '';
            listEl.innerHTML = '';
            (data.files || []).forEach(fn => {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = {{ url_for('download', run_id='__RUN__', filename='__FN__')|tojson }}.replace('__RUN__', runId).replace('__FN__', fn);
              a.textContent = fn;
              li.appendChild(a);
              listEl.appendChild(li);
            });
          }
        } catch (e) {}
        if (!done) setTimeout(poll, 1200);
      }
      poll();
    </script>
  </body>
  </html>
